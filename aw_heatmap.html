<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Heatmap + bar chart: call types along the year in various neighborhoods</title>

    <!-- Load Bulma from CDN (consider saving it to repository instead) -->
    <!-- https://bulma.io/ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">

    <!-- Load Font Awesome 5 (free) icons -->
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  </head>

  <body>

  <!-- Page header -->
  <!-- https://bulma.io/documentation/layout/hero/ -->
  <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">Distribution of call types along the year</h1>
        <h2 class="subtitle">In various neighborhoods</h2>
      </div>
    </div>
  </section>
  <!-- End page header -->

  <!-- Page navigation -->
  <!-- https://bulma.io/documentation/components/navbar/ -->
  <nav class="navbar is-light" role="navigation" aria-label="main navigation">
    <div class="container">
      <div class="navbar-brand">

        <a class="navbar-item is-active" href="index.html">
          <span class="icon"><i class="fas fa-home"></i></span>
          <span>Home</span>
        </a>

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="main-menu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="main-menu" class="navbar-menu has-text-weight-medium">
        <!-- Left navbar items -->
        <div class="navbar-start">
          <a class="navbar-item" href="#data" title="Data">
            <span>Data</span>
          </a>

          <a class="navbar-item" href="#visualizations" title="Data">
            <span>Visualizations</span>
          </a>

        </div>
      </div>
    </div>
  </nav>
  <!-- End page navigation -->

  <section class="section">
    <div class="container">
      <!-- Begin page content -->
      <div class="content">
        <h1 class="title">
          Heatmap + bar chart
        </h1>
        <p class="subtitle">
          by Alex Wang
        </p>

        <p> </p>
        <h2 id="data">Data</h2>

        <ol>
          <li><strong>Call type group: </strong> Call types are divided into four main groups: Fire, Alarm, Potential Life Threatening and Non Life Threatening.</li>

          <li><strong>Response DtTm: </strong> Date and time this unit acknowledges the dispatch and records that the unit is en route to the location of the call.</li>

          <li><strong>Neighborhooods - Analysis Boundaries:</strong> Neighborhood District associated with this address, boundaries available here: https://data.sfgov.org/d/p5b7-5n3h</li>

          <li><strong>Number of Records: </strong> Count of records.</li>
        </ol>


        <h2 id="visualizations">Visualizations</h2>

        <h3> protorype by Tableau </h3>
        <img src="Prototype3.png" width="1440" height="900">


        <h3>D3 version</h3>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <div id="d3hm"></div>

        <script>

        let csv = "Fire_Department_Calls_for_Service05.csv";

        // configuration of svg/plot area
        let config = {
          'svg': {},
          'margin': {},
          'plot': {}
        };

        config.svg.height = 500;
        config.svg.width = 960; // golden ratio

        config.margin.top = 10;
        config.margin.right = 10;
        config.margin.bottom = 20;
        config.margin.left = 160;

        config.plot.x = config.margin.left;
        config.plot.y = config.margin.top;
        config.plot.width = config.svg.width - config.margin.left - config.margin.right;
        config.plot.height = config.svg.height - config.margin.top - config.margin.bottom;


        // setup svg
        let svg = d3.select('#d3hm').append('svg');
        svg.attr('width', config.svg.width);
        svg.attr('height', config.svg.height);

        // setup plot area
        let plot = svg.append('g');
        plot.attr('id', 'plot');
        plot.attr('transform', translate(config.plot.x, config.plot.y));

        // use a rect to illustrate plot area
        let rect = plot.append('rect');
        rect.attr('id', 'background');

        rect.attr('x', 0);
        rect.attr('y', 0);
        rect.attr('width', config.plot.width);
        rect.attr('height', config.plot.height);

        // scales for data
        let scale = {};

        scale.x = d3.scaleBand();
        scale.x.range([0, config.plot.width]);

        scale.y = d3.scaleBand();
        scale.y.range([config.plot.height, 0]);

        // https://github.com/d3/d3-scale-chromatic
        scale.color = d3.scaleSequential(d3.interpolateOranges);


        let axis = {};  // axes for data
        axis.x = d3.axisBottom(scale.x);
        axis.x.tickPadding(0);

        axis.y = d3.axisLeft(scale.y);
        axis.y.tickPadding(0);


        // format the tick labels
  //      axis.x.tickFormat(dateFormatter);
  //      axis.y.tickFormat(regionFormatter);

        var callTypeGroupName = ["Fire", "Potentially Life-Threatening", "Alarm", "Non Life-threatening", "NullType"]
//        let CTG = data.map(row => row['Call_Type_Group']);

        let ctgMap = new Map(); //call type group map
        let nbhMap = new Map(); //beighborhood map

        let currCount = 0;
        let parseDateName = d3.timeParse('%m/%d/%Y');
        let formatDateNumber = d3.timeFormat("%m");
        let formatDateName = d3.timeFormat("%B");
        monthColNames = ['January', 'Feburary', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];

        d3.csv(csv, recordRow).then(convertData).then(drawAxis).then(drawHeatmap);

        function recordRow(row, index) {
          let callTypeGroup = row['Call_Type_Group'];
          let monthNumberName= row['Response_DtTm'];
          let neighborhoods = row['Neighborhooods'];
          let ResponseDate = row['Response_DtTm'];

            var typeName = callTypeGroup;
          //      console.log("ctg: " + typeName);
            var dateNum = monthNumberName;
          //        console.log("month: " + dateNum);
            var monthNum = formatDateNumber(parseDateName(dateNum));
            var monthName = formatDateName(parseDateName(dateNum));
          //      console.log("\t ==> " + monthName + " = " + monthNum);
            var nbhd = neighborhoods;
          //      console.log("neighborhood: " + nbhd);

            if(typeName == "") {
              typeName = "NullType";
            }

            var monthArrIndex = parseInt(monthNum, 10) - 1;
          //        console.log("month index: " + monthArrIndex);

            if(ctgMap.get(typeName)) {
              monthList = ctgMap.get(typeName);
          //      console.log(typeName + ": " + monthList + ";\n");
              origCount = monthList[monthArrIndex];
              monthList[monthArrIndex] = origCount + 1;

            } else{
              monthList = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
              monthList[monthArrIndex] = 1;

            }
            ctgMap.set(typeName, monthList);


            return ctgMap;
      }

      function convertData(map) {
        console.log("look at key:" + ctgMap.get('Fire'));
        console.log("look at key:" + ctgMap.get('Potentially Life-Threatening'));
        console.log("look at key:" + ctgMap.get('Alarm'));
        console.log("look at key:" + ctgMap.get('Non Life-threatening'));
        console.log("look at key:" + ctgMap.get('NullType'));
        let res = [];
        let oneRow = {};
        oneRow.values = [];

        count = 0;
        oneRow['callTypeGroup'] = "Fire";
        while(count < 12) {
          oneRow.values.push({
            'month': monthColNames[count],
            'value': ctgMap.get('Fire')[count]
          });
          count++;
        }
        res[0] = oneRow;



        oneRow = {};
        oneRow.values = [];
        oneRow['callTypeGroup'] = "Potentially Life-Threatening";
        count = 0;
        while(count < 12) {
          oneRow.values.push({
            'month': monthColNames[count],
            'value': ctgMap.get('Potentially Life-Threatening')[count]
          });
          count++;
        }
        res[1] = oneRow;




        oneRow = {};
        oneRow.values = [];
        oneRow['callTypeGroup'] = "Alarm";
        count = 0;
        while(count < 12) {
          oneRow.values.push({
            'month': monthColNames[count],
            'value': ctgMap.get('Alarm')[count]
          });
          count++;
        }
        res[2] = oneRow;



        oneRow = {};
        oneRow.values = [];
        oneRow['callTypeGroup'] = "Non Life-threatening";
        count = 0;
        while(count < 12) {
          oneRow.values.push({
            'month': monthColNames[count],
            'value': ctgMap.get('Non Life-threatening')[count]
          });
          count++;
        }
        res[3] = oneRow;



        oneRow = {};
        oneRow.values = [];
        oneRow['callTypeGroup'] = "NullType";
        count = 0;
        while(count < 12) {
          oneRow.values.push({
            'month': monthColNames[count],
            'value': ctgMap.get('NullType')[count]
          });
          count++;
        }
        res[4] = oneRow;

        console.log(res);

        console.log("ending of func2");
        return res;
      }


      function drawAxis(data) {
        console.log("drawmap.");
        console.log(data);

        let ctg = callTypeGroupName;
//        console.log(ctg);

        let dates = monthColNames;
  //      console.log(dates);

        // now that we have data set the scale domain
        scale.x.domain(dates);
        scale.y.domain(ctg);

        // draw the x and y axis
        let gx = svg.append('g');
        gx.attr("id", "x-axis");
        gx.attr("class", "axis");
        gx.attr("transform", translate(config.plot.x, config.plot.y + config.plot.height));
        gx.call(axis.x);

        let gy = svg.append('g');
        gy.attr("id", "y-axis");
        gy.attr("class", "axis");
        gy.attr("transform", translate(config.plot.x, config.plot.y));
        gy.call(axis.y);

        return data;
}




      function drawHeatmap(data) {

        allValues = ctgMap.get('Fire').concat(ctgMap.get('Potentially Life-Threatening'),
                ctgMap.get('Alarm'), ctgMap.get('Non Life-threatening'), ctgMap.get('NullType'))

        // calculate the min, max, and median
        let min = d3.min(allValues);
        let max = d3.max(allValues);
        let mid = d3.mean(allValues);

        scale.color.domain([min, mid, max]);

        // create one group per row
        let rows = plot.selectAll("g.cell")
          .data(data)
          .enter()
          .append("g");
        rows.attr("class", "cell");

        rows.attr("transform", function(d) {
          return translate(0, scale.y(d["Call_Type_Group"]));
        });


          let cells = rows.selectAll("rect")
            .data(d => d.values)
            .enter()
            .append("rect");

              cells.attr("x", d => scale.x(d.month));
              cells.attr("y", 0); // handled by group transform
              cells.attr("width", scale.x.bandwidth());
              cells.attr("height", scale.y.bandwidth());

              // here is the color magic!
              cells.style("fill", d => scale.color(d.value));
              cells.style("stroke", d => scale.color(d.value));

      }



      // helper method to make translating easier
      function translate(x, y) {
        return 'translate(' + x + ',' + y + ')';
      }


        </script>
<!--TODO--><!--TODO--><!--TODO--><!--TODO--><!--TODO--><!--TODO--><!--TODO--><!--TODO--><!--TODO-->


        <h4>Instructions</h4>

        <p> The color of boxes in heatmap indicates the count of calling records, the x-axis of heatmap is the response date and time of SFFD's action, and y-axis is the call type. In the bar chart, each bar is a neighborhood and length is the count of calls. </p>

        <h4>Discussion</h4>
        <p> Firstly, in the heatmap, we could see the comparison between months that how the fire calls distributed, that there is no huge difference of number of calls among months. Also from the y-axis we could see the comparison between different types of calls, such as "potentially life-threatening" has much more number of call than that of other types.
        Moreover, in the barchart, we could see how are situation of neighborhoods on fire calls.</p>

        <h3> Planned interactivity</h3>
        <p> When clicking on specific box on heatmap, the relavent bar chart for that call type at that time for all neighborhoods would show.</p>

        <img src="hm100.png" width="1440" height="900">
        <img src="hm200.png" width="1440" height="900">
        <img src="hm300.png" width="1440" height="900">
        <img src="hm500.png" width="1440" height="900">
        <img src="hm600.png" width="1440" height="900">


        <h3> Connection to the project theme</h3>
        <p> This visualization explore several situation about works in SFFD.
          Firstly it shows how different call types take parts in all number of calls, so that we could know what kind of works do the SFFD do. For example, we would know that fire calls is not taking the major part of calls to SFFD.
        Also it shows the call type distributions along the year, and we could know that the calls to SFFD is not dependent on season or month or certain holidays, etc.
        Furthremore, if we switch between different data types, the specific number of calls for the same month on neightborhood would be different, so it could be potentially useful for SFFD to deploy different resource near different neighborhood, etc.</p>



  <!-- Mobile menu responsiveness -->
  <!-- https://bulma.io/documentation/components/navbar/ -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    if ($navbarBurgers.length > 0) {
      $navbarBurgers.forEach( el => {
        el.addEventListener('click', () => {
          const target = el.dataset.target;
          const $target = document.getElementById(target);
          el.classList.toggle('is-active');
          $target.classList.toggle('is-active');
        });
      });
    }
  });
  </script>
  <!-- End mobile menu responsiveness -->
  </body>

</html>
